@using Domain.Books
@using Web.Enums
@using Web.Validators

@rendermode InteractiveServer

@page "/books/list"

<style>
    /* ===== CARD VIEW WITH HOVER EFFECTS ===== */
    .book-card {
        display: flex;
        flex-direction: row;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 12px;
        overflow: hidden;
        background: linear-gradient(145deg, var(--mud-palette-surface) 0%, var(--mud-palette-background) 100%);
        height: 180px;
    }

    .book-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    }

    .book-card-image-container {
        flex-shrink: 0;
        width: 120px;
        height: 100%;
        position: relative;
        overflow: hidden;
    }

    .book-card-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .book-card:hover .book-card-image {
        transform: scale(1.08);
    }

    .book-card-image-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--mud-palette-primary-darken) 0%, var(--mud-palette-primary) 100%);
    }

    .book-card-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 16px;
        min-width: 0;
        position: relative;
    }

    .book-card-volume-badge {
        position: absolute;
        bottom: 8px;
        left: 8px;
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(4px);
        border-radius: 6px;
        padding: 4px 8px;
        color: white;
        font-size: 0.75rem;
        font-weight: 600;
    }

    /* ===== MAGAZINE/COVER VIEW ===== */
    .book-cover-card {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        aspect-ratio: 2/3;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .book-cover-card:hover {
        transform: scale(1.03);
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
    }

    .book-cover-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .book-cover-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--mud-palette-primary-darken) 0%, var(--mud-palette-primary) 100%);
        color: white;
        padding: 16px;
        text-align: center;
    }

    .book-cover-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.9));
        padding: 60px 16px 16px 16px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .book-cover-card:hover .book-cover-overlay {
        opacity: 1;
    }

    .book-cover-actions {
        position: absolute;
        top: 8px;
        right: 8px;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .book-cover-card:hover .book-cover-actions {
        opacity: 1;
    }

    .book-cover-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        border-radius: 20px;
        padding: 4px 10px;
    }

    /* ===== COMPACT LIST VIEW ===== */
    .book-list-row {
        transition: all 0.2s ease;
        border-radius: 8px;
        margin-bottom: 8px;
    }

    .book-list-row:hover {
        background-color: var(--mud-palette-action-default-hover);
        transform: translateX(4px);
    }

    .book-list-image {
        width: 50px;
        height: 70px;
        object-fit: cover;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .book-list-placeholder {
        width: 50px;
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--mud-palette-primary-darken) 0%, var(--mud-palette-primary) 100%);
        border-radius: 6px;
        color: white;
    }

    /* Hide cover column on mobile/tablet in list view (matches MudTable Sm breakpoint) */
    @@media (max-width: 959.95px) {
        .list-cover-cell {
            display: none !important;
        }
    }

    /* Align action buttons to the right in responsive table mode */
    .action-buttons {
        display: flex;
        justify-content: flex-end;
    }

    /* ===== VIEW TOGGLE ===== */
    .view-toggle-btn {
        min-width: 44px;
    }

    /* ===== GENERAL ===== */
    .stats-card {
        background: linear-gradient(135deg, var(--mud-palette-primary) 0%, var(--mud-palette-primary-darken) 100%);
        border-radius: 12px;
        color: white;
    }
</style>

<div class="ma-4">
    <!-- Header with title, view toggle, and action button -->
    <div class="d-flex align-center justify-space-between flex-wrap gap-3 mb-4">
        <div class="d-flex align-center">
            <MudIcon Class="mr-2" Icon="@Icons.Material.Filled.MenuBook" Size="Size.Large" Color="Color.Primary" />
            <MudText Typo="Typo.h4" Class="font-weight-bold">Books</MudText>
            <MudChip T="string" Size="Size.Small" Color="Color.Primary" Class="ml-3">@Books.Count</MudChip>
        </div>

        <div class="d-flex align-center gap-2">
            <!-- View Mode Toggle -->
            <MudButtonGroup OverrideStyles="false" Class="mr-2">
                <MudTooltip Text="Card View">
                    <MudIconButton Icon="@Icons.Material.Filled.ViewModule"
                                   Color="@(CurrentViewMode == ViewMode.Cards ? Color.Primary : Color.Default)"
                                   Variant="@(CurrentViewMode == ViewMode.Cards ? Variant.Filled : Variant.Outlined)"
                                   OnClick="@(() => CurrentViewMode = ViewMode.Cards)"
                                   Class="view-toggle-btn" />
                </MudTooltip>
                <MudTooltip Text="Cover View">
                    <MudIconButton Icon="@Icons.Material.Filled.GridView"
                                   Color="@(CurrentViewMode == ViewMode.Covers ? Color.Primary : Color.Default)"
                                   Variant="@(CurrentViewMode == ViewMode.Covers ? Variant.Filled : Variant.Outlined)"
                                   OnClick="@(() => CurrentViewMode = ViewMode.Covers)"
                                   Class="view-toggle-btn" />
                </MudTooltip>
                <MudTooltip Text="List View">
                    <MudIconButton Icon="@Icons.Material.Filled.ViewList"
                                   Color="@(CurrentViewMode == ViewMode.List ? Color.Primary : Color.Default)"
                                   Variant="@(CurrentViewMode == ViewMode.List ? Variant.Filled : Variant.Outlined)"
                                   OnClick="@(() => CurrentViewMode = ViewMode.List)"
                                   Class="view-toggle-btn" />
                </MudTooltip>
            </MudButtonGroup>

            <MudButton StartIcon="@Icons.Material.Filled.Add"
                       Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="@(e => CreateOrEditAsync(FormMode.Create, null))">
                New Book
            </MudButton>
        </div>
    </div>

    <!-- Content based on view mode -->
    @if (Books.Count == 0)
    {
        <MudPaper Class="pa-8 d-flex flex-column align-center justify-center" Style="min-height: 400px;" Elevation="0">
            <MudIcon Icon="@Icons.Material.Filled.LibraryBooks" Size="Size.Large" Color="Color.Primary" Style="font-size: 80px; opacity: 0.5;" />
            <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mt-4">No books in your collection yet</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">Start by adding your first book</MudText>
            <MudButton StartIcon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Primary" OnClick="@(e => CreateOrEditAsync(FormMode.Create, null))">
                Add Your First Book
            </MudButton>
        </MudPaper>
    }
    else
    {
        @switch (CurrentViewMode)
        {
            case ViewMode.Cards:
                @RenderCardsView()
                break;
            case ViewMode.Covers:
                @RenderCoversView()
                break;
            case ViewMode.List:
                @RenderListView()
                break;
        }
    }
</div>

@* ===== CARDS VIEW WITH HOVER EFFECTS ===== *@
@{
    RenderFragment RenderCardsView() => @<MudGrid Spacing="4">
        @foreach (var book in Books)
        {
            <MudItem xs="12" sm="6" md="4" lg="3">
                <MudPaper Class="book-card" Elevation="2">
                    @* Image Section - Full Height *@
                    <div class="book-card-image-container">
                        @if (!string.IsNullOrEmpty(book.ImageLink))
                        {
                            <MudImage Src="@book.ImageLink" Alt="@book.Title" Class="book-card-image" />
                        }
                        else
                        {
                            <div class="book-card-image-placeholder">
                                <MudIcon Icon="@Icons.Material.Filled.MenuBook" Size="Size.Large" Style="color: white; opacity: 0.7;" />
                            </div>
                        }
                        @if (book.VolumeNumber > 0)
                        {
                            <div class="book-card-volume-badge">Vol. @book.VolumeNumber</div>
                        }
                    </div>

                    @* Content Section *@
                    <div class="book-card-content">
                        @* Header with title and menu *@
                        <div class="d-flex justify-space-between align-start">
                            <div class="flex-grow-1 pr-2" style="min-width: 0;">
                                <MudText Typo="Typo.subtitle1" Class="font-weight-bold" Style="line-height: 1.3; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@book.Title</MudText>
                                @if (!string.IsNullOrEmpty(book.Serie))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Primary" Class="font-weight-medium" Style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">@book.Serie</MudText>
                                }
                            </div>
                            <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                                <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="@(e => CreateOrEditAsync(FormMode.Edit, book))">Edit</MudMenuItem>
                                <MudMenuItem Icon="@Icons.Material.Filled.Delete" IconColor="Color.Error" OnClick="@(e => DeleteAsync(book.Id))">Delete</MudMenuItem>
                            </MudMenu>
                        </div>

                        @* Book details *@
                        <div class="d-flex flex-column gap-1 mt-3 flex-grow-1">
                            <div class="d-flex align-center gap-2">
                                <MudIcon Icon="@Icons.Material.Filled.QrCode" Size="Size.Small" Color="Color.Secondary" />
                                <MudText Typo="Typo.caption" Color="Color.Secondary" Style="font-family: monospace;">@book.ISBN</MudText>
                            </div>
                            @if (book.Rating > 0)
                            {
                                <MudRating SelectedValue="@book.Rating" MaxValue="5" ReadOnly="true" Size="Size.Small" Class="mt-1" />
                            }
                        </div>

                        @* Footer with read status *@
                        @if (book.ReadingDates.Any())
                        {
                            <div class="d-flex align-center gap-1 mt-auto pt-2">
                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Color="Color.Success" />
                                <MudText Typo="Typo.caption" Color="Color.Success">Read @book.ReadingDates.MaxBy(rd => rd.Date)!.Date.ToString("MMM yyyy")</MudText>
                            </div>
                        }
                    </div>
                </MudPaper>
            </MudItem>
        }
    </MudGrid>;
}

@* ===== MAGAZINE/COVER VIEW ===== *@
@{
    RenderFragment RenderCoversView() => @<MudGrid Spacing="3">
        @foreach (var book in Books)
        {
            <MudItem xs="6" sm="4" md="3" lg="2">
                <MudPaper Class="book-cover-card" Elevation="4">
                    @if (!string.IsNullOrEmpty(book.ImageLink))
                    {
                        <MudImage Src="@book.ImageLink" Alt="@book.Title" Class="book-cover-image" />
                    }
                    else
                    {
                        <div class="book-cover-placeholder">
                            <MudIcon Icon="@Icons.Material.Filled.MenuBook" Size="Size.Large" Style="opacity: 0.8; margin-bottom: 8px;" />
                            <MudText Typo="Typo.subtitle2" Class="font-weight-bold">@book.Title</MudText>
                            @if (!string.IsNullOrEmpty(book.Serie))
                            {
                                <MudText Typo="Typo.caption" Style="opacity: 0.8;">@book.Serie</MudText>
                            }
                        </div>
                    }

                    @if (book.VolumeNumber > 0)
                    {
                        <div class="book-cover-badge">
                            <MudText Typo="Typo.caption" Style="color: white; font-weight: 600;">Vol. @book.VolumeNumber</MudText>
                        </div>
                    }

                    <div class="book-cover-actions">
                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small" Color="Color.Inherit" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                            <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="@(e => CreateOrEditAsync(FormMode.Edit, book))">Edit</MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.Delete" IconColor="Color.Error" OnClick="@(e => DeleteAsync(book.Id))">Delete</MudMenuItem>
                        </MudMenu>
                    </div>

                    <div class="book-cover-overlay">
                        <MudText Typo="Typo.subtitle2" Class="font-weight-bold" Style="color: white; line-height: 1.2;">@book.Title</MudText>
                        @if (!string.IsNullOrEmpty(book.Serie))
                        {
                            <MudText Typo="Typo.caption" Style="color: rgba(255,255,255,0.8);">@book.Serie</MudText>
                        }
                        @if (book.Rating > 0)
                        {
                            <MudRating SelectedValue="@book.Rating" MaxValue="5" ReadOnly="true" Size="Size.Small" Class="mt-1" />
                        }
                    </div>
                </MudPaper>
            </MudItem>
        }
    </MudGrid>;
}

@* ===== COMPACT LIST VIEW ===== *@
@{
    RenderFragment RenderListView() => @<MudPaper Elevation="0">
        <MudTable Items="@Books" Hover="true" Breakpoint="Breakpoint.Xs" Dense="true" Striped="true" Class="rounded-lg">
            <HeaderContent>
                <MudTh Class="list-cover-cell"></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<Book, object>(x => x.Title)">Title</MudTableSortLabel></MudTh>
                <MudTh><MudTableSortLabel SortBy="new Func<Book, object>(x => x.Serie)">Series</MudTableSortLabel></MudTh>
                <MudTh>ISBN</MudTh>
                <MudTh Style="text-align: center;"><MudTableSortLabel SortBy="new Func<Book, object>(x => x.VolumeNumber)">Vol.</MudTableSortLabel></MudTh>
                <MudTh Style="text-align: center;"><MudTableSortLabel SortBy="new Func<Book, object>(x => x.Rating)">Rating</MudTableSortLabel></MudTh>
                <MudTh Style="text-align: center;">Read</MudTh>
                <MudTh Style="text-align: right;">Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Cover" Style="width: 70px;" Class="list-cover-cell">
                    @if (!string.IsNullOrEmpty(context.ImageLink))
                    {
                        <MudImage Src="@context.ImageLink" Alt="@context.Title" Class="book-list-image" />
                    }
                    else
                    {
                        <div class="book-list-placeholder">
                            <MudIcon Icon="@Icons.Material.Filled.MenuBook" Size="Size.Small" />
                        </div>
                    }
                </MudTd>
                <MudTd DataLabel="Title">
                    <MudText Typo="Typo.body2" Class="font-weight-medium">@context.Title</MudText>
                </MudTd>
                <MudTd DataLabel="Series">
                    <MudText Typo="Typo.body2" Color="Color.Primary">@context.Serie</MudText>
                </MudTd>
                <MudTd DataLabel="ISBN">
                    <MudText Typo="Typo.caption" Style="font-family: monospace;">@context.ISBN</MudText>
                </MudTd>
                <MudTd DataLabel="Volume" Style="text-align: center;">
                    <MudChip T="string" Size="Size.Small" Color="Color.Default">@context.VolumeNumber</MudChip>
                </MudTd>
                <MudTd DataLabel="Rating" Style="text-align: center;">
                    @if (context.Rating > 0)
                    {
                        <MudRating SelectedValue="@context.Rating" MaxValue="5" ReadOnly="true" Size="Size.Small" />
                    }
                    else
                    {
                        <MudText Typo="Typo.caption" Color="Color.Secondary">-</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Read" Style="text-align: center;">
                    @if (context.ReadingDates.Any())
                    {
                        <MudTooltip Text="@($"Last read: {context.ReadingDates.MaxBy(rd => rd.Date)!.Date:d}")">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                        </MudTooltip>
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Outlined.RadioButtonUnchecked" Color="Color.Default" Size="Size.Small" />
                    }
                </MudTd>
                <MudTd DataLabel="Actions" Style="text-align: right;" Class="list-actions-cell">
                    <div class="action-buttons">
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" Color="Color.Primary" OnClick="@(e => CreateOrEditAsync(FormMode.Edit, context))" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(e => DeleteAsync(context.Id))" />
                    </div>
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 10, 25, 50, 100 }" />
            </PagerContent>
        </MudTable>
    </MudPaper>;
}
