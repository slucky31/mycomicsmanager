@using Application.Libraries.Create
@using Application.Libraries.GetById
@using Application.Libraries.Update
@using Domain.Libraries
@using Domain.Primitives
@using MediatR
@using MongoDB.Bson
@inject IMediator Mediator
@inject NavigationManager MyNavigationManager
@rendermode InteractiveServer

<MudStack Spacing="1" Class="mt-2">

    <MudPaper class=" py-4 px-6 mx-4 rounded" Elevation="0" Align="Align.Center">
        <MudGrid Class="d-flex align-center">
            <MudItem xs="12" sm="2">
                <MudText Typo="Typo.h5">Libraries</MudText>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (errors.Count() > 0)
    {
        <MudPaper class=" py-4 px-6 mx-4 rounded" Elevation="0" Align="Align.Center">
            <MudAlert Severity="Severity.Error" Variant="Variant.Filled">
                @foreach (var error in errors)
                {
                    <MudText>@error</MudText>
                }
            </MudAlert>
        </MudPaper>
    }

    <MudPaper class=" py-4 px-6 mx-4 rounded" Elevation="0" Align="Align.Center">
        <MudForm @ref="form">
            <MudTextField T="string" Label="Name" Required="true" RequiredError="User name is required!" @bind-Value="LibraryName" />
        </MudForm>
    </MudPaper>

    <MudPaper class=" py-4 px-6 mx-4 rounded" Elevation="0" Align="Align.Center">
        <MudButton Class="ml-auto mt-3 mb-3" Variant="Variant.Filled" Color="Color.Primary" DisableElevation="true" OnClick="@(async ()=>await CreateOrUpdateLibrary())">Validate</MudButton>
    </MudPaper>

</MudStack>


@code {

    [Parameter]
    public string? LibraryId { get; set; }

    MudForm? form;
    public string? LibraryName { get; set; }
    List<string> errors = new();

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrWhiteSpace(LibraryId))
        {
            LibraryName = "";
        }
        else
        {
            var result = await Mediator.Send(new GetLibraryQuery(new ObjectId(LibraryId)));
            if (result.IsSuccess)
            {
                var library = result.Value;
                Guard.Against.Null(library);
                LibraryName = library.Name;
            }            
        }
    }

    private async Task CreateOrUpdateLibrary()
    {
        errors.Clear();

        Result<Library> result;
        if (string.IsNullOrWhiteSpace(LibraryId))
        {
            result = await CreateLibrary();            
        }
        else
        {
            result = await UpdateLibrary();            
        }

        if (result.IsFailure)
        {
            if (result.Error == LibrariesError.Duplicate)
            {
                errors.Add("Library name already exists");
            }
            else if (result.Error == LibrariesError.BadRequest)
            {
                errors.Add("Invalid library name");
            }
            else
            {
                errors.Add("Invalid library name");
            }
        }
        else
        {
            MyNavigationManager.NavigateTo("/libraries/list");            
        }        
    }

    private async Task<Result<Library>> CreateLibrary() => await Mediator.Send(new CreateLibraryCommand(LibraryName ?? ""));

    private async Task<Result<Library>> UpdateLibrary() => await Mediator.Send(new UpdateLibraryCommand(new ObjectId(LibraryId), LibraryName ?? ""));

}
