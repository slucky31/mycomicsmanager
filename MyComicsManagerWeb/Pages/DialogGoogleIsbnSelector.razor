@using MyComicsManagerWeb.Services
@using Google.Apis.Books.v1
@using Google.Apis.Books.v1.Data
@using Google.Apis.Services
@using MyComicsManager.Model.Shared
@using MyComicsManagerWeb.Models
@using Serilog

@inject BookInformationService _bookInfoService

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Recherche via Google Books</MudText>

    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="Query" Label="Search" Variant="Variant.Outlined" Adornment="Adornment.End" AdornmentIcon="@Icons.Filled.Search" AdornmentColor="Color.Primary" OnAdornmentClick="@Search" OnClearButtonClick="@Search" OnKeyDown="@Enter"/>
        <MudContainer Style="max-height: 650px; overflow-y: scroll">
            @if (_bookInfo != null && _bookInfo.Any())
            {
                <MudTable Items="@_bookInfo" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_processing" LoadingProgressColor="Color.Info">
                    <HeaderContent>
                        <MudTh>Title</MudTh>
                        <MudTh>ISBN</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Title">@context.Title</MudTd>
                        <MudTd DataLabel="ISBN">@context.Isbn</MudTd>
                        <MudTd DataLabel="Actions">
                            @{
                                <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.Search" OnClick="() => SearchIsbn(context)" Title="Search ISBN"/>
                                @if (@context.IsIsbnChecked)
                                {
                                    <MudIconButton Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.Check" OnClick="() => SelectComic(context)" Title="@context.ToString()"/>
                                }
                                else
                                {
                                    <MudIconButton Size="Size.Small" Icon="@Icons.Material.Filled.Check" Title="Select" Disabled="true"/>
                                }
                            }
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
        </MudContainer>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="MudDialog.Cancel">Cancel</MudButton>
    </DialogActions>

</MudDialog>

@code {

    [CascadingParameter]
    MudDialogInstance MudDialog { get; set; }

    [Parameter]
    public string Title { get; set; }

    public string Query { get; set; }

    [Inject]
    private IWebserviceSettings Settings { get; set; }

    private bool _processing;

    private List<GoogleBookInfo> _bookInfo = new();

    private bool _waitingIsbnSearchStatuts = false;

    protected override void OnInitialized()
    {
        Query = Title;
    }

    private async Task Search()
    {
        Log.Information("Search");
        if (!string.IsNullOrEmpty(Query))
        {
            _processing = true;
            
            var service = new BooksService(new BaseClientService.Initializer
            {
                // https://console.developers.google.com/apis/credentials?project=mycomicsmanager
                ApiKey = Settings.ApiGoogleKey,
                ApplicationName = "mycomicsmanager"
            });

            var listRequest = new VolumesResource.ListRequest(service, Query)
            {
                MaxResults = 10,
                ShowPreorders = false,
                LangRestrict = "fr",
                PrintType = VolumesResource.ListRequest.PrintTypeEnum.BOOKS,
                OrderBy = VolumesResource.ListRequest.OrderByEnum.Relevance
            };

            var volumes = await listRequest.ExecuteAsync();
            foreach (var volume in volumes.Items)
            {
                _bookInfo.Add(new GoogleBookInfo(volume));
            }
            _processing = false;
        }
    }

    private async Task Enter(KeyboardEventArgs e)
    {
        if (e.Code is "Enter" or "NumpadEnter")
        {
            await Search();
        }
    }
    
    private async Task SearchIsbn(GoogleBookInfo googleBookInfo)
    {
        _waitingIsbnSearchStatuts = true;
        var tmpComic = await _bookInfoService.SearchBookInfoAsync(googleBookInfo.Isbn);
    
        if (null == tmpComic)
        {
            googleBookInfo.IsIsbnChecked = false;
        }
        else
        {
            googleBookInfo.IsIsbnChecked = true;
            googleBookInfo.searchComic = tmpComic;
        }
        
        _waitingIsbnSearchStatuts = false;
        this.StateHasChanged();
    }

    private void SelectComic(GoogleBookInfo googleBookInfo)
    {
        MudDialog.Close(DialogResult.Ok(googleBookInfo));
    }
    
}