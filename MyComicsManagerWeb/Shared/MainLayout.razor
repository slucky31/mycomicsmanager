@using System.Security.Claims
@using Microsoft.AspNetCore.Identity
@using MyComicsManagerWeb.Models
@inherits LayoutComponentBase

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager;
@inject SignInManager<ApplicationUser> SignInManager;

<MudThemeProvider Theme="_currentTheme" />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudText Typo="Typo.h5" Class="ml-3">MyComicsManager</MudText>
        <MudSpacer />
        
        @if (_user.Identity.IsAuthenticated)
        {
            <MudMenu AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                <ActivatorContent>
                    <MudAvatar>
                        <MudIcon Icon="@Icons.Material.Filled.PersonPin" Size="Size.Large" />
                    </MudAvatar>
                </ActivatorContent>
                <ChildContent>
                    <MudNavMenu Rounded="true" Margin="Margin.Dense" Color="Color.Primary" Class="pa-2">
                        <MudText Typo="Typo.h6" Class="px-4">@_user.Identity.Name</MudText>
                        <MudText Typo="Typo.body2" Class="px-4 mud-text-secondary">@_user.FindFirstValue(ClaimTypes.Email)</MudText>
                        <MudDivider Class="my-2" />
                        <MudNavLink Href="/profile" Icon="@Icons.TwoTone.ManageAccounts">Profile</MudNavLink>
                        <MudNavLink OnClick="DarkMode" Icon="@Icons.Material.TwoTone.BrightnessMedium">Switch theme</MudNavLink>
                        <MudNavLink Href="/settings" Icon="@Icons.TwoTone.Settings">Settings</MudNavLink>
                        <MudNavLink OnClick="LogOut" Icon="@Icons.TwoTone.Logout">Log Out</MudNavLink>
                    </MudNavMenu>
                </ChildContent>
            </MudMenu>
        }
    </MudAppBar>
    <MudMainContent>
        @Body
    </MudMainContent>
    <!--<MudAppBar Elevation="1" Style="top: auto; bottom: 0">
        This is footer
    </MudAppBar>-->
</MudLayout>

@code {

    private ClaimsPrincipal _user;
    
    protected override async Task OnInitializedAsync()  
    {  
        _currentTheme = _defaultTheme;
        
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();  
        _user = authState.User;
    } 

    void DarkMode()
    {
        _currentTheme = (_currentTheme != _defaultTheme) ? _defaultTheme : _darkTheme;
    }

    void LogOut()
    {
        NavigationManager.NavigateTo("/Account/LogoutInternal", true);
    }

    MudTheme _currentTheme = new MudTheme();

    readonly MudTheme _defaultTheme = new MudTheme()
    {
        Palette = new PaletteLight()
    };

    readonly MudTheme _darkTheme = new MudTheme()
    {
        Palette = new PaletteDark()
    };
}
