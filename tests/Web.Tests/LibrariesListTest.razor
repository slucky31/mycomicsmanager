@using AngleSharp.Dom
@using Domain.Libraries
@using Domain.Primitives
@using MockQueryable
@using MockQueryable.EntityFrameworkCore
@using MockQueryable.NSubstitute
@using MudBlazor.Services
@using NSubstitute
@using Persistence.Queries.Helpers
@using Web.Components.Pages
@using Web.Services
@inherits TestContext

@code{

    private readonly ILibrariesService _librariesServiceMock;
    private readonly int nbItems = 10;

    public LibrariesListTest()
    {                
        JSInterop.Mode = JSRuntimeMode.Loose;
        _librariesServiceMock = Substitute.For<ILibrariesService>();
        Services.AddSingleton(_librariesServiceMock);
        Services.AddMudServices();
        RenderComponent<MudPopoverProvider>();
    }

    [Fact]
    public void LibraryList_Should_RenderCorrectly_When_NoDataProvided()
    {
        // Act
        var comp = RenderComponent<LibrairiesList>();

        // Assert
        comp.Should().NotBeNull();
        comp.FindComponents<PageWithAction>().Count.Should().Be(1);        
        comp.FindComponents<MudGrid>().Count.Should().Be(1);       

    }

    [Fact]
    public async Task LibraryList_Should_RenderCorrectly_When_DataAreProvided()
    {

        // Arrange
        List<Library> list = new();
        for (int i = 0; i < nbItems; i++)
        {
            Library lib = Library.Create(Guid.NewGuid().ToString());
            list.Add(lib);
        }
        var query = list.AsQueryable().BuildMock();
        var mockPagedList = new PagedList<Library>(query);
        await mockPagedList.ExecuteQueryAsync(1, nbItems);
        _librariesServiceMock.FilterBy(Arg.Any<string>(), Arg.Any<LibrariesColumn>(), Arg.Any<SortOrder>(), Arg.Any<int>(), Arg.Any<int>()).Returns(mockPagedList);

        // Act
        var comp = RenderComponent<LibrairiesList>();

        // Assert
        comp.Should().NotBeNull();
        comp.FindComponents<PageWithAction>().Count.Should().Be(1);
        comp.FindComponents<MudGrid>().Count.Should().Be(1);
        var cards = comp.FindComponents<MudCard>();
        cards.Count.Should().Be(nbItems);    

        // Assert - Each card
        foreach(var card in cards)
        {                        
            var header = card.FindComponents<MudCardHeader>();
            header.Should().HaveCount(1); 

            var mudText = header[0].FindComponent<MudText>();
            mudText.Should().NotBeNull();
            mudText.Markup.Should().Contain(list[cards.ToList().IndexOf(card)].Name);

            var mudMenu = header[0].FindComponent<MudMenu>();
            mudMenu.Should().NotBeNull();

            var content = card.FindComponents<MudCardContent>();
            content.Should().HaveCount(1);
            content[0].FindComponents<MudText>().Count.Should().Be(4);
        }                
    }

    

}
